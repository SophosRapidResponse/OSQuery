/*************************** Sophos.com/RapidResponse ***************************\
| DESCRIPTION                                                                    |
| Check for files on disk located in the main windows directories with specific  |
| file extensions we see threat actors and malware using. Limit on btime to      |
| reduce noise                                                                   |
|                                                                                |
| VARIABLE                                                                       |
| - start_time (DATE) - btime greater than or equal to                           |
| - end_time (DATE) -  btime less than                                           |
|                                                                                |
| Version: 1.2                                                                   |
| Author: @AltShiftPrtScn | Elida Leite                                          |
| github.com/SophosRapidResponse                                                 |
\********************************************************************************/

SELECT 
	f.path AS Path,
	f.directory AS Directory,
	f.filename AS Filename,
	regex_match(LOWER(f.filename), '(\.exe|\.dll|\.bat|\.cmd|\.vbs|\.ps1|\.js|\.dmp|\.txt|\.hta|\.iso|\.html)$', 0) AS file_extension,
	f.size AS Size,
	strftime('%Y-%m-%dT%H:%M:%SZ',datetime(f.btime,'unixepoch')) AS 'created_time', 
	strftime('%Y-%m-%dT%H:%M:%SZ',datetime(f.mtime,'unixepoch')) AS 'modified_time', 
	CAST (h.sha256 AS Text) SHA256,
	f.file_version AS File_Version,
	CASE WHEN filename LIKE regex_match(LOWER(f.filename), '(.*)(\.exe|\.dll)$', 0) THEN (SELECT authenticode.result || ' ' || '-' || ' ' || authenticode.subject_name FROM authenticode WHERE f.path = authenticode.path)
	ELSE '-' END AS signature_check,
	CASE WHEN filename LIKE regex_match(LOWER(f.filename), '(.*)(\.bat|\.cmd|\.ps1|\.js|\.hta)$', 0) THEN (SELECT CAST(GROUP_CONCAT(line,CHAR(10)) AS TEXT) FROM grep WHERE pattern IN (CHAR(0),CHAR(10),CHAR(32)) AND path = f.path)  
	ELSE '-' END AS script_content,
	'File/Hash/Authenticode' AS Data_Source,
	'Common Malware Location on Win Directories' AS Query
FROM file f 
JOIN hash h ON f.path = h.path
WHERE (f.path LIKE 'C:\Windows\%' 
	OR f.path LIKE 'C:\Windows\Temp\%' 
	OR f.path LIKE 'C:\Windows\System32\%' 
	OR f.path LIKE 'C:\Windows\SysWOW64\%'
	) 
	AND (f.filename LIKE '%.exe' 
		OR f.filename LIKE '%.dll' 
		OR f.filename LIKE '%.bat' 
		OR f.filename LIKE '%.cmd' 
		OR f.filename LIKE '%.vbs' 
		OR f.filename LIKE '%.ps1' 
		OR f.filename LIKE '%.js' 
		OR f.filename LIKE '%.dmp' 
		OR f.filename LIKE '%.txt'
		OR f.filename LIKE '%.hta'
		OR f.filename LIKE '%.iso'
		OR f.filename LIKE '%.html') 
	AND f.btime >= CAST($$start_time$$ AS INT) 
	AND f.btime <= CAST($$end_time$$ AS INT)
ORDER BY signature_check