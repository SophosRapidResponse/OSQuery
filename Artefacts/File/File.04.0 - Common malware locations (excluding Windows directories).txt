/*************************** Sophos.com/RapidResponse ***************************\
| DESCRIPTION                                                                    |
| Check for files on disk located in common locations with specific file         |
| extensions we see threat actors and malware using. This excludes the windows   |
| directories to reduce the noise.                                               |
|                                                                                |
| VARIABLE                                                                       |
| - start_time (DATE) - time_type greater than or equal to                       |
| - end_time (DATE) -  time_type less than or equal to                           |
|                                                                                |
| Version: 1.2                                                                   |
| Author: @AltShiftPrtScn | Elida Leite                                          |
| github.com/SophosRapidResponse                                                 |
\********************************************************************************/

SELECT 
	f.path AS Path,
	f.directory AS Directory,
	f.filename AS Filename,
	regex_match(LOWER(f.filename), '(\.exe|\.dll|\.bat|\.cmd|\.vbs|\.ps1|\.js|\.dmp|\.txt|\.hta|\.iso|\.html)$', 0) AS file_extension,
	f.size AS Size,
	strftime('%Y-%m-%dT%H:%M:%SZ',datetime(f.btime,'unixepoch')) AS 'created_time', 
	strftime('%Y-%m-%dT%H:%M:%SZ',datetime(f.mtime,'unixepoch')) AS 'modified_time', 
	h.sha256 AS SHA256,
	f.file_version AS File_Version,
	CASE WHEN filename LIKE regex_match(LOWER(filename), '(.*)(\.exe|\.dll)$', 0) THEN (SELECT authenticode.result || ' ' || '-' || ' ' || authenticode.subject_name FROM authenticode WHERE f.path = authenticode.path)
	ELSE '-' END AS signature_check,
	CASE WHEN filename LIKE regex_match(LOWER(filename), '(.*)(\.bat|\.cmd|\.ps1|\.js|\.hta)$', 0) THEN (SELECT CAST(GROUP_CONCAT(line,CHAR(10)) AS TEXT) FROM grep WHERE pattern IN (CHAR(0),CHAR(10),CHAR(32)) AND path = f.path) 
	ELSE '-' END AS script_content,
	'File/Hash/Authenticode' AS Data_Source,
	'Common Malware Location w/o Windows Directories' AS Query
FROM file f 
JOIN hash h ON f.path = h.path
WHERE (f.path LIKE 'C:\%' 
	OR f.path LIKE 'C:\ProgramData\%' 
	OR f.path LIKE 'C:\Perflogs\%' 
	OR f.path LIKE 'C:\Intel\%' 
	OR f.path LIKE 'C:\Temp\%'
	OR f.path LIKE 'C:\Users\Public\%%' 
	OR f.path LIKE 'C:\Users\%\Downloads\%'
	OR f.path LIKE 'C:\Users\%\Desktop\%' 
	OR f.path LIKE 'C:\Users\%\Music\%%' 
	OR f.path LIKE 'C:\Users\%\Pictures\%%'
	OR f.path LIKE 'C:\Users\%\AppData\Local\Temp\%' 
	OR f.path LIKE 'C:\Users\%\AppData\Local\Microsoft\Windows\INetCache\Content.Outlook\%'
	)
	AND (f.filename LIKE '%.exe' 
		OR f.filename LIKE '%.dll' 
		OR f.filename LIKE '%.bat' 
		OR f.filename LIKE '%.cmd' 
		OR f.filename LIKE '%.vbs' 
		OR f.filename LIKE '%.ps1' 
		OR f.filename LIKE '%.js' 
		OR f.filename LIKE '%.dmp' 
		OR f.filename LIKE '%.txt'
		OR f.filename LIKE '%.hta'
		OR f.filename LIKE '%.iso'
		OR f.filename LIKE '%.html') 
	AND f.btime >= CAST($$start_time$$ AS INT) 
	AND f.btime <= CAST($$end_time$$ AS INT)
ORDER BY signature_check 