/*************************** Sophos.com/RapidResponse ***************************\
| DESCRIPTION                                                                    |
| Check for files on disk located in the main windows directories with specific  |
| file extensions we see threat actors and malware using. Limit on btime to      |
| reduce noise                                                                   |
|                                                                                |
| VARIABLE                                                                       |
| begin(date) - time_type greater than or equal to                               |
| end(date) -  time_type less than                                               |
| time_type(string) - btime, ctime, mtime, atime                                 |
|                                                                                |
| Version: 1.1                                                                   |
| Author: @AltShiftPrtScn                                                        |
| github.com/SophosRapidResponse                                                 |
\********************************************************************************/

SELECT 
f.path AS Path,
f.directory AS Directory,
f.filename AS Filename,
f.size AS Size,
strftime('%Y-%m-%dT%H:%M:%SZ',datetime(f.btime,'unixepoch')) AS 'First_Created_On_Disk(btime)', 
strftime('%Y-%m-%dT%H:%M:%SZ',datetime(f.ctime,'unixepoch')) AS 'Last_Status_Change(ctime)', 
strftime('%Y-%m-%dT%H:%M:%SZ',datetime(f.mtime,'unixepoch')) AS 'Last_Modified(mtime)', 
strftime('%Y-%m-%dT%H:%M:%SZ',datetime(f.atime,'unixepoch')) AS 'Last_Accessed(atime)',
h.sha256 AS SHA256,
h.sha1 AS SHA1,
h.md5 AS MD5,
f.attributes AS Attributes,
f.file_version AS File_Version,
'File/Hash' AS Data_Source,
'File.04.1' AS Query
FROM file f 
JOIN hash h ON f.path = h.path
WHERE (f.path LIKE 'C:\Windows\%' OR f.path LIKE 'C:\Windows\Temp\%' OR f.path LIKE 'C:\Windows\System32\%' OR f.path LIKE 'C:\Windows\SysWOW64\%')
AND (f.filename LIKE '%.exe' OR f.filename LIKE '%.dll' OR f.filename LIKE '%.bat' OR f.filename LIKE '%.cmd' OR f.filename LIKE '%.vbs' OR f.filename LIKE '%.ps1' 
OR f.filename LIKE '%.js' OR f.filename LIKE '%.dmp' OR f.filename LIKE '%.txt') AND f.$$time_type$$ >= CAST($$begin$$ AS INT) AND f.$$time_type$$ < CAST($$end$$ AS INT)