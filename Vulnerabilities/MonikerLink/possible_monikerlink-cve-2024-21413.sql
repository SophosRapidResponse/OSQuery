/*************************** Sophos.com/RapidResponse ***************************\
| DESCRIPTION                                                                    |
| Query to identify possible MonikerLink exploitation (CVE-2024-21413)           |
|                                                                                |
| VARIABLE                                                                       |
| - begin (type: DATE)                                                           |
| - end (type: DATE)                                                             |
|                                                                                |
| Query Type: Endpoint                                                           |
| Version: 1.0                                                                   |
| Author: The Rapid Response Team | Lee Kirkpatrick                              |
| github.com/SophosRapidResponse                                                 |
\********************************************************************************/


WITH evtx_files AS (
    SELECT filename
    FROM file
    WHERE (path LIKE 'C:\Windows\System32\winevt\Logs\%')
        AND filename LIKE '%.evtx'
)

SELECT
    datetime,
    eventid,
    source,
    data
FROM
    sophos_windows_events
WHERE 
    source IN (SELECT REPLACE(REPLACE(filename, '.evtx', ''), '%4', '/') FROM evtx_files)
    AND time > $$begin$$
    AND time < $$end$$
    AND data LIKE '%file:%!%'
