/*************************** Sophos.com/RapidResponse ****************************\
| DESCRIPTION                                                                     |
| Detects possible exploitation of ScreenConnect Server by analyzing newly created|
| users within the User.xml file. Further investigation of the User.xml file and  |
| ScreenConnect audit logs for unexpected new users is needed to determine        |
| compromise. While the query provides an initial insight into a potential        |
| compromise of ScreenConnect, it could yield false positive results.             |
|                                                                                 |
| Query Type: Data Lake                                                           |
| Author: The MDR team                                                            |
| github.com/SophosRapidResponse                                                  |
\*********************************************************************************/

SELECT
ingestion_timestamp,
customer_id,
JSON_EXTRACT_SCALAR(raw, '$.host_identifier') as host_identifier,
JSON_EXTRACT_SCALAR(raw, '$.meta_hostname') as meta_hostname,
JSON_EXTRACT_SCALAR(raw, '$.meta_username') as meta_username,
JSON_EXTRACT_SCALAR(raw, '$.ioc_event_threat_source') as ioc_event_threat_source,
JSON_EXTRACT_SCALAR(raw, '$.ioc_event_ttp_summary') as ioc_event_ttp_summary,
JSON_EXTRACT_SCALAR(raw, '$.ioc_event_path') as ioc_event_path,
JSON_EXTRACT_SCALAR(raw, '$.ioc_event_event') as ioc_event_event,
raw 
FROM mdr_ioc_all
WHERE
    JSON_EXTRACT_SCALAR(raw, '$.ioc_event_threat_source') = 'VDL'
    AND JSON_EXTRACT_SCALAR(raw, '$.ioc_event_ttp_summary') = 'TA0002-T1203'
    AND JSON_EXTRACT_SCALAR(raw, '$.ioc_event_event') LIKE '%TFT/XML-A%'