/*************************** Sophos.com/RapidResponse *****************************\
| DESCRIPTION                                                                      |
| Detects suspicious code execution from vulnerable PaperCut versions MF/NG        |
|                                                                                  |
| VARIABLES:                                                                       |
| - start_time: (DATE)                                                             |
| - end_time: (DATE)                                                               |
|                                                                                  |
| REFERENCE:                                                                       |
| https://www.papercut.com/kb/Main/PO-1216-and-PO-1219#faqs                        |
| Version: 1.0                                                                     |
| Author: The Rapid Response Team|                                                 |
| github.com/SophosRapidResponse                                                   |
\**********************************************************************************/

SELECT 
strftime('%Y-%m-%dT%H:%M:%SZ', datetime(spj.time, 'unixepoch')) AS date_time,
spj.cmd_line,
spj.sophos_pid,
users.username,
spj.sid,
spj.parent_sophos_pid,
CAST((SELECT spj2.process_name FROM sophos_process_journal spj2 WHERE spj2.sophos_pid = spj.parent_sophos_pid) AS text) parent_process,
CAST((SELECT spj2.path FROM sophos_process_journal spj2 WHERE spj2.sophos_pid = spj.parent_sophos_pid) AS text) parent_process_path
FROM sophos_process_journal spj 
LEFT JOIN users ON spj.sid = users.uuid
WHERE LOWER(parent_process) IN ('pc-app.exe')
    AND LOWER(spj.process_name) IN ('cmd.exe', 'powershell.exe')
    AND LOWER(parent_process_path) LIKE '%papercut%'
    AND spj.time >= $$start_time$$ 
    AND spj.time <= $$end_time$$